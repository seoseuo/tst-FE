name: Deploy with Docker

on:
  push:
    branches:
      - main

jobs:
  # Build Job: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Create .env.local file from Secrets
        run: |
          echo "NEXT_PUBLIC_SPRINGBOOT_URL=${{ secrets.NEXT_PUBLIC_SPRINGBOOT_URL }}" >> .env.local
          echo "NEXT_PUBLIC_S3_URL=${{ secrets.NEXT_PUBLIC_S3_URL }}" >> .env.local          

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Docker Image
        run: |
          docker build --no-cache -t seuo/tst-fe-image:latest .
          docker push seuo/tst-fe-image:latest

  # Deploy Job: ë¹Œë“œ í›„ ë°°í¬
  deploy:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Set up SSH Key
        run: |
          echo "${{ secrets.PEM_KEY }}" | base64 --decode > private-key.pem
          chmod 600 private-key.pem

      - name: Deploy to Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key_path: private-key.pem
          script: |
            cd ~/wannago-deploy || mkdir ~/wannago-deploy && cd ~/wannago-deploy

            # ğŸ”¥ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ë³µ ë°©ì§€ìš© ì •ë¦¬
            docker stop wannago_fe || true
            docker rm wannago_fe || true
            docker stop nginx || true
            docker rm nginx || true
            docker stop goaccess || true
            docker rm goaccess || true

            # ìµœì‹  í”„ë¡ íŠ¸ì—”ë“œ ì´ë¯¸ì§€ pull
            docker pull seuo/tst-fe-image:latest

            # ğŸ§¾ docker-compose.yml ìƒì„±
            cat <<EOF > docker-compose.yml
            version: "3.8"

            services:
              frontend:
                container_name: tst-fe
                image: seuo/tst-fe-image:latest
                restart: always
                expose:
                  - "3000"
                networks:
                  - frontend-net

              nginx:
                image: nginx:latest
                container_name: nginx
                ports:
                  - "80:80"
                volumes:
                  - ./nginx.conf:/etc/nginx/nginx.conf:ro
                  - ./nginx-logs:/var/log/nginx
                depends_on:
                  - frontend
                networks:
                  - frontend-net

              goaccess:
                image: allinurl/goaccess
                container_name: goaccess
                environment:
                  - GOACCESS_ACCESS_LOG=/var/log/nginx/access.log
                  - GOACCESS_OUTPUT_FILE=/usr/share/nginx/html/report.html
                ports:
                  - "7890:7890"  # GoAccess ëŒ€ì‹œë³´ë“œ í¬íŠ¸
                volumes:
                  - ./nginx-logs:/var/log/nginx
                  - ./goaccess-report:/usr/share/nginx/html
                networks:
                  - frontend-net
                depends_on:
                  - nginx

            networks:
              frontend-net:
                driver: bridge
            EOF

            # ğŸ› ï¸ nginx.conf ìƒì„± (Next.js 3000 í¬íŠ¸ë¡œ í”„ë¡ì‹œ)
            cat <<EOF > nginx.conf
            events {}
            http {
              access_log /var/log/nginx/access.log;
              server {
                listen 80;
                location / {
                  proxy_pass http://frontend:3000;
                  proxy_set_header Host \$host;
                  proxy_set_header X-Real-IP \$remote_addr;
                  proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto \$scheme;
                }
              }
            }
            EOF

            docker compose down
            docker compose up -d
